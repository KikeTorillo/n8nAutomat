{
  "name": "deepseek oficial",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ae59cdbc-961a-4f31-b9e5-701b82d25f1c",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -688,
        240
      ],
      "id": "ed8b01a3-74d4-4363-8cef-a0daf22952b0",
      "name": "Webhook",
      "webhookId": "7af99ef6-681f-4699-8f62-fbff165fed3b"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "20a0b009-eb9b-44fc-bda9-4dffd8085f04",
              "name": "sender",
              "value": "={{ $json.body.data.key.remoteJid }}",
              "type": "string"
            },
            {
              "id": "2763de37-d1d4-4564-9980-eeb091c9afd6",
              "name": "messageType",
              "value": "={{ $json.body.data.messageType }}",
              "type": "string"
            },
            {
              "id": "6076cf73-bc7d-41d6-b053-c09611925c31",
              "name": "conversation",
              "value": "={{ $json.body.data.message.conversation }}",
              "type": "string"
            },
            {
              "id": "f7e32389-50f8-4633-913c-6f233ff7656e",
              "name": "sessionId",
              "value": "={{ $json.body.data.key.id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -496,
        240
      ],
      "id": "94071eb7-9d8d-4a88-84db-2cbee1300098",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=http://evolution_api:8080/message/sendText/{{ $('Webhook').item.json.body.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "apikey",
              "value": "EvoAPIKey123!"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Edit Fields').item.json.sender.split('@')[0] }}"
            },
            {
              "name": "text",
              "value": "={{ $json.output }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        176,
        240
      ],
      "id": "e907c1f4-75cc-4209-93e4-fb85de1c4c89",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.conversation }}",
        "options": {
          "systemMessage": "=Eres un asistente llamado JARVIS que interpreta mensajes recibidos por WhatsApp para gestionar citas en Google Calendar.\n\nHoy es {{ $now }}. Zona horaria: America/Mexico City\n\nTu trabajo es entender lo que el usuario necesita y actuar en consecuencia, usando las herramientas disponibles. Solo gestionas citas. No respondes preguntas generales.\n\nPuedes realizar las siguientes tareas:\n- crear_evento: cuando el usuario quiere agendar una cita nueva\n- reprogramar_evento: cuando quiere cambiar la fecha o la hora de una cita existente\n- eliminar_evento: cuando quiere cancelar una cita existente\n- consultar_evento: cuando quiere saber cu√°ndo tiene una cita\n\nEjemplos de mensajes y sus intenciones:\n- ‚ÄúAgenda una reuni√≥n con Laura ma√±ana a las 4‚Äù = crear_evento\n- ‚ÄúPasemos la cita del lunes para el mi√©rcoles‚Äù = reprogramar_evento\n- ‚ÄúCancela la reuni√≥n de hoy‚Äù = eliminar_evento\n- ‚Äú¬øQu√© tengo esta semana?‚Äù = consultar_evento\n\nHerramientas disponibles seg√∫n la tarea:\n- crear_evento = agendar cita\n- reprogramar_evento = reprogramar cita\n- eliminar_evento = cancelar cita\n- consultar_evento = consultar citas\n\nTu respuesta debe ser en lenguaje natural, clara y breve, como si estuvieras escribiendo por WhatsApp. Usa emojis si es apropiado.\n\nExtrae toda la informaci√≥n posible del mensaje: t√≠tulo, fecha, hora, duraci√≥n y ubicaci√≥n. Si alg√∫n dato importante no est√° claro (por ejemplo, la hora), preg√∫ntalo de forma amable antes de ejecutar la acci√≥n.\n\nEjemplos de respuesta:\n- Evento creado: ‚ÄúListo, agend√© tu cita ‚ÄòReuni√≥n con Laura‚Äô para ma√±ana a las 4:00 p.m. üòä‚Äù\n- Evento reprogramado: ‚ÄúHe actualizado tu cita. Ahora es el mi√©rcoles a las 3:00 p.m.‚Äù\n- Evento eliminado: ‚ÄúHe cancelado tu cita programada para hoy. Si necesitas otra, dime. üëç‚Äù\n- Consulta: ‚ÄúTienes una cita ‚ÄòReuni√≥n con equipo‚Äô el viernes a las 10:00 a.m.‚Äù\n\nSi el mensaje es ambiguo o no se entiende qu√© desea el usuario, p√≠dele amablemente que aclare su intenci√≥n.\n\nNo devuelvas estructuras t√©cnicas ni generes JSON. Tu √∫nica salida debe ser una respuesta conversacional humana.\n\nPuedes usar la memoria de los √∫ltimos 10 mensajes del usuario para mantener el contexto si es necesario.\n\nTen en cuenta estas expresiones comunes de fecha y su interpretaci√≥n:\n- ‚Äúma√±ana a las 10am‚Äù = d√≠a siguiente a la fecha actual, a las 10:00 a.m.\n- ‚Äúel pr√≥ximo lunes‚Äù = el lunes siguiente a la fecha actual\n- ‚Äúdentro de 8 d√≠as‚Äù = ocho d√≠as despu√©s de la fecha actual\n- ‚Äúel mes que viene‚Äù = el mismo d√≠a del mes siguiente\n- ‚Äúeste viernes por la tarde‚Äù = si el viernes ya pas√≥ esta semana, se refiere al pr√≥ximo viernes\n\nSi no se menciona una duraci√≥n espec√≠fica para la cita, asume que es de una hora.\n\nCuando uses una herramienta, aseg√∫rate de proporcionar correctamente estos datos si est√°n disponibles en el mensaje del usuario:\n- T√≠tulo del evento = summary\n- Fecha y hora de inicio = startTime (formato ISO 8601)\n- Fecha y hora de finalizaci√≥n = endTime (puede calcularse si hay duraci√≥n)\n- Descripci√≥n = description (opcional)\n- Ubicaci√≥n = location (opcional)\n\nNo incluyas enlaces de videollamadas (como Google Meet) en tus respuestas, aunque la herramienta los devuelva."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -288,
        240
      ],
      "id": "cc1753da-bf8d-4a89-884c-baadf20062a4",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatDeepSeek",
      "typeVersion": 1,
      "position": [
        -288,
        448
      ],
      "id": "534a90ed-0850-4196-98f9-43ae88e84b0d",
      "name": "DeepSeek Chat Model",
      "credentials": {
        "deepSeekApi": {
          "id": "SaUmLewmkKh6vwdl",
          "name": "DeepSeek account"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        -192,
        560
      ],
      "id": "b47e768d-a686-4c10-b28d-25bf407935c9",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "YUuD1hpbAIsb6wNj",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "value": "arellanestorillo@gmail.com",
          "mode": "list",
          "cachedResultName": "arellanestorillo@gmail.com"
        },
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        -48,
        448
      ],
      "id": "380438bd-d6ac-4ec3-a697-906e398766e8",
      "name": "agenda_cita",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "IVedjf5oSNuOMwLb",
          "name": "Google Calendar account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DeepSeek Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "agenda_cita": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "c21d4fd5-dfe8-42f1-a0fb-83f0a87b1960",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "3befaac49988b9c648ba08e4c625531296a9ea8e4bfc1bb257fdbc966d390514"
  },
  "id": "NQ0aLc5CakETds8g",
  "tags": []
}